; PlatformIO Project Configuration File - CORRECTED VERSION
; T-Deck-Pro OS - LilyGo T-Deck-Pro 4G Hardware
; CRITICAL: All configurations corrected to match actual hardware

[env:tdeck-pro-4g]
; CORRECTED: Use proper ESP32-S3 board definition for T-Deck-Pro
platform = espressif32@6.5.0
board = esp32-s3-devkitc-1
framework = arduino

; CRITICAL FIX: Correct board configuration for T-Deck-Pro hardware
board_build.mcu = esp32s3
board_build.variant = esp32s3
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = qio
board_build.partitions = huge_app.csv

; CRITICAL FIX: Memory configuration for T-Deck-Pro (16MB Flash, 8MB PSRAM)
board_build.arduino.memory_type = qio_opi
board_build.memory_type = qio_opi
board_upload.flash_size = 16MB
board_upload.maximum_size = 16777216

; CRITICAL FIX: Enable PSRAM for T-Deck-Pro (8MB available)
board_build.arduino.psram_type = opi
board_build.psram_type = opi
build_flags = 
    -DBOARD_HAS_PSRAM
    -DARDUINO_ESP32S3_DEV
    -DESP32S3
    -DARDUINO_RUNNING_CORE=1
    -DARDUINO_EVENT_RUNNING_CORE=1
    -DCORE_DEBUG_LEVEL=4
    -DCONFIG_ARDUHAL_ESP_LOG
    ; Hardware-specific flags
    -DBOARD_TDECK_PRO_4G=1
    -DBOARD_EPD_WIDTH=240
    -DBOARD_EPD_HEIGHT=320
    -DBOARD_HAS_EPD=1
    -DBOARD_HAS_4G_MODEM=1
    -DBOARD_HAS_LORA=1
    -DBOARD_HAS_GPS=1
    -DBOARD_HAS_SENSORS=1
    -DBOARD_HAS_SD=1
    ; Display configuration
    -DGXEPD2_DISPLAY_CLASS=GxEPD2_BW
    -DGXEPD2_DRIVER_CLASS=GxEPD2_310_GDEQ031T10
    -DGXEPD2_BW_IS_GxEPD2_BW=1
    ; Communication flags
    -DWIFI_ENABLED=1
    -DMODEM_4G_ENABLED=1
    -DLORA_ENABLED=1
    -DGPS_ENABLED=1
    ; OS Configuration
    -DOS_VERSION=\"1.0.0\"
    -DSERIAL_BAUD_RATE=115200
    -DWATCHDOG_TIMEOUT_SEC=30
    -DBATTERY_LOW_VOLTAGE=3.3
    -DBATTERY_CRITICAL_VOLTAGE=3.0

; Upload configuration
upload_protocol = esptool
upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; CRITICAL FIX: All library dependencies corrected and verified
lib_deps = 
    ; Core ESP32 libraries
    Wire
    SPI
    WiFi
    WiFiClientSecure
    HTTPClient
    ArduinoJson@^6.21.4
    ; CRITICAL FIX: Correct E-ink display library for GDEQ031T10
    ZinggJM/GxEPD2@^1.5.3
    ; Graphics and UI libraries
    Adafruit GFX Library@^1.11.9
    lovyan03/LovyanGFX@^1.1.12
    ; CRITICAL FIX: LVGL version compatible with ESP32-S3 and corrected config
    lvgl/lvgl@^8.3.11
    ; Communication libraries
    ; 4G Modem support (A7682E)
    vshymanskyy/TinyGSM@^0.11.7
    ; LoRa support (SX1262)
    sandeepmistry/LoRa@^0.8.0
    ; GPS support
    mikalhart/TinyGPSPlus@^1.0.3
    ; Storage and file system
    ; SD card support
    ; JSON configuration
    bblanchon/ArduinoJson@^6.21.4
    ; Sensor libraries
    ; Light sensor (LTR-553ALS)
    ; Gyroscope (BHI260AP) 
    ; Touch controller (CST328)
    ; Keyboard controller (TCA8418)
    adafruit/Adafruit TCA8418@^1.0.1
    ; Battery management (BQ27220, BQ25896)
    ; System utilities
    ESP Async WebServer@^1.2.3
    AsyncTCP@^1.1.1
    ; Time and RTC
    ; Crypto and security
    ; Networking
    PubSubClient@^2.8
    ; File system
    LittleFS_esp32@^1.0.6
    ; Debug and logging
    ; Audio (disabled on 4G version due to pin conflicts)
    ; Audio libraries commented out for 4G version
    ; ESP8266Audio@^1.9.7  ; DISABLED: Audio pins conflict with 4G modem
    ; Additional utilities
    ; OneButton@^2.0.3  ; For button handling
    ; FastLED@^3.6.0    ; For status LEDs if needed

; CRITICAL FIX: Corrected build configuration
build_type = debug
build_src_filter = 
    +<*>
    -<.git/>
    -<.svn/>
    -<example/>
    -<examples/>
    -<test/>
    -<tests/>

; Development environment configuration
[env:tdeck-pro-4g-release]
extends = env:tdeck-pro-4g
build_type = release
build_flags = 
    ${env:tdeck-pro-4g.build_flags}
    -DCORE_DEBUG_LEVEL=1
    -Os
    -DNDEBUG

; Testing environment
[env:tdeck-pro-4g-test]
extends = env:tdeck-pro-4g
build_flags = 
    ${env:tdeck-pro-4g.build_flags}
    -DUNIT_TEST=1
    -DTEST_MODE=1

; OTA environment
[env:tdeck-pro-4g-ota]
extends = env:tdeck-pro-4g
upload_protocol = espota
upload_port = 192.168.1.100  ; Update with actual IP

; Global configuration
[platformio]
default_envs = tdeck-pro-4g
src_dir = src
include_dir = include
lib_dir = lib
data_dir = data

; Custom scripts
extra_scripts = 
    pre:scripts/pre_build.py
    post:scripts/post_build.py

; Library configuration
[lib]
; CRITICAL FIX: Library compatibility settings
lib_ldf_mode = deep+
lib_compat_mode = strict

; LVGL configuration - corrected for ESP32-S3
[lvgl]
; Memory allocation corrected for ESP32-S3 with PSRAM
LV_MEM_CUSTOM = 1
LV_MEM_SIZE = 262144  ; 256KB for LVGL (reasonable for ESP32-S3)
LV_MEM_ADR = 0        ; Use malloc
LV_COLOR_DEPTH = 1    ; 1-bit for E-ink display
LV_COLOR_16_SWAP = 0  ; Not needed for 1-bit
LV_TICK_CUSTOM = 1    ; Custom tick for ESP32
LV_DISP_DEF_REFR_PERIOD = 5000  ; 5 second refresh for E-ink

; Hardware-specific library configurations
[gxepd2]
; E-ink display configuration
ENABLE_GxEPD2_GFX = 1
ENABLE_GxEPD2_display = 1

[tinygsm]
; 4G Modem configuration for A7682E
TINY_GSM_MODEM_A7672X = 1
TINY_GSM_RX_BUFFER = 1024
TINY_GSM_DEBUG = Serial

[lora]
; LoRa configuration for SX1262
LORA_DEFAULT_SPI_FREQUENCY = 8E6
LORA_DEFAULT_SS_PIN = 3      ; BOARD_LORA_CS
LORA_DEFAULT_RESET_PIN = 4   ; BOARD_LORA_RST
LORA_DEFAULT_DIO0_PIN = 5    ; BOARD_LORA_DIO1

; Build optimization
[build]
; Compiler optimizations
build_unflags = 
    -Os
build_flags = 
    -O2
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections
    -fno-rtti
    -fno-exceptions

; Debugging configuration
[debug]
debug_tool = esp-prog
debug_init_break = tbreak setup
debug_build_flags = 
    -O0
    -g3
    -ggdb

; Custom tasks
[tasks]
; Clean build artifacts
clean = pio run --target clean

; Upload filesystem
uploadfs = pio run --target uploadfs

; Monitor serial output  
monitor = pio device monitor --baud 115200

; Generate documentation
docs = doxygen Doxyfile

; Run unit tests
test = pio test

; Create OTA package
ota_package = 
    pio run --environment tdeck-pro-4g-ota
    python scripts/create_ota_package.py

; Flash bootloader
flash_bootloader = 
    esptool.py --chip esp32s3 --port $UPLOAD_PORT --baud 921600 
    write_flash --flash_mode dio --flash_freq 80m --flash_size 16MB 
    0x0 bootloader.bin 0x8000 partitions.bin 0xe000 boot_app0.bin

; Factory reset
factory_reset = 
    esptool.py --chip esp32s3 --port $UPLOAD_PORT erase_flash

; Memory analysis
memory_analysis = 
    pio run --target size-data
    pio run --target size-components

; Performance profiling
profile = 
    pio run --environment tdeck-pro-4g --target size
    python scripts/memory_profiler.py

; Hardware validation
hw_test = 
    pio run --environment tdeck-pro-4g-test --target upload
    python scripts/hardware_validator.py